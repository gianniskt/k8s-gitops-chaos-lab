{
  "name": "GitOps Lab (k3d)",
  "image": "ghcr.io/gianniskt/azure-gitops-image:latest",
  "containerUser": "myuser",

  // k3d needs Docker socket access and host .kube access
  "mounts": [
    "source=/var/run/docker.sock,target=/var/run/docker.sock,type=bind",
    "source=${localEnv:USERPROFILE}/.kube,target=/host-kube,type=bind,consistency=cached"
  ],
  
  // Docker features for k3d
  "features": {
    "ghcr.io/devcontainers/features/docker-outside-of-docker:1": {
      "version": "latest",
      "enableNonRootDocker": "true"
    }
  },

  // Workspace configuration
  "workspaceMount": "source=${localWorkspaceFolder},target=/workspaces/${localWorkspaceFolderBasename},type=bind,consistency=cached",
  "workspaceFolder": "/workspaces/${localWorkspaceFolderBasename}",

  // Setup commands - copy host kubeconfig and modify k3d context if present
  "postCreateCommand": "mkdir -p ~/.kube && cp /host-kube/config ~/.kube/config 2>/dev/null || echo 'No host kubeconfig found' && if kubectl config get-contexts k3d-gitops-chaos >/dev/null 2>&1; then kubectl config set-cluster k3d-gitops-chaos --server=https://host.docker.internal:6550; fi",

  // VS Code customizations
  "customizations": {
    "vscode": {
      "settings": {
        "terminal.integrated.defaultProfile.linux": "bash",
        "terminal.integrated.profiles.linux": {
          "bash": {
            "path": "/bin/bash"
          }
        },
        "mcp": {
          "servers": {
            "flux-operator-mcp": {
              "command": "flux-operator-mcp",
              "args": ["serve"],
              "env": {
                "KUBECONFIG": "/home/myuser/.kube/config"
              }
            }
          }
        },
        "chat.mcp.enabled": true
      },
      "extensions": [
        "mhutchie.git-graph",
        "github.vscode-github-actions",
        "ms-kubernetes-tools.vscode-kubernetes-tools",
        "ms-vscode.vscode-mcp",
        "redhat.vscode-yaml",
        "ms-vscode.vscode-json"
      ]
    }
  },

  // Use myuser user
  "remoteUser": "myuser"
}