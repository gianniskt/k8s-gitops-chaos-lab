---
# Install only Traefik Middleware CRD (not Gateway API CRDs)
apiVersion: v1
kind: ConfigMap
metadata:
  name: traefik-middleware-crd-installer
  namespace: traefik
data:
  install-middleware-crd.sh: |
    #!/bin/bash
    set -e
    
    echo "Installing Traefik Middleware CRD..."
    
    # Fetch the Traefik chart to get the Middleware CRD
    TRAEFIK_VERSION="v3.2.2"
    
    kubectl apply -f - <<EOF
    apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    metadata:
      annotations:
        controller-gen.kubebuilder.io/version: v0.16.5
      name: middlewares.traefik.io
    spec:
      group: traefik.io
      names:
        kind: Middleware
        listKind: MiddlewareList
        plural: middlewares
        singular: middleware
      scope: Namespaced
      versions:
      - name: v1alpha1
        schema:
          openAPIV3Schema:
            description: Middleware is the CRD implementation of a Traefik Middleware.
            properties:
              apiVersion:
                type: string
              kind:
                type: string
              metadata:
                type: object
              spec:
                description: MiddlewareSpec defines the desired state of a Middleware.
                properties:
                  addPrefix:
                    properties:
                      prefix:
                        type: string
                    type: object
                  basicAuth:
                    properties:
                      headerField:
                        type: string
                      realm:
                        type: string
                      removeHeader:
                        type: boolean
                      secret:
                        type: string
                    type: object
                  buffering:
                    properties:
                      maxRequestBodyBytes:
                        format: int64
                        type: integer
                      maxResponseBodyBytes:
                        format: int64
                        type: integer
                      memRequestBodyBytes:
                        format: int64
                        type: integer
                      memResponseBodyBytes:
                        format: int64
                        type: integer
                      retryExpression:
                        type: string
                    type: object
                  chain:
                    properties:
                      middlewares:
                        items:
                          properties:
                            name:
                              type: string
                            namespace:
                              type: string
                          required:
                          - name
                          type: object
                        type: array
                    type: object
                  compress:
                    properties:
                      excludedContentTypes:
                        items:
                          type: string
                        type: array
                      minResponseBodyBytes:
                        type: integer
                    type: object
                  headers:
                    properties:
                      customRequestHeaders:
                        additionalProperties:
                          type: string
                        type: object
                      customResponseHeaders:
                        additionalProperties:
                          type: string
                        type: object
                    type: object
                  stripPrefix:
                    properties:
                      forceSlash:
                        type: boolean
                      prefixes:
                        items:
                          type: string
                        type: array
                    type: object
                type: object
            required:
            - metadata
            - spec
            type: object
        served: true
        storage: true
    EOF
    
    echo "Traefik Middleware CRD installed successfully!"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: traefik-middleware-crd-installer
  namespace: traefik
spec:
  ttlSecondsAfterFinished: 100
  template:
    spec:
      serviceAccountName: traefik-middleware-crd-installer
      restartPolicy: OnFailure
      containers:
      - name: installer
        image: bitnami/kubectl:latest
        command: ["/bin/bash", "/scripts/install-middleware-crd.sh"]
        volumeMounts:
        - name: script
          mountPath: /scripts
      volumes:
      - name: script
        configMap:
          name: traefik-middleware-crd-installer
          defaultMode: 0755
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: traefik-middleware-crd-installer
  namespace: traefik
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: traefik-middleware-crd-installer
rules:
- apiGroups: ["apiextensions.k8s.io"]
  resources: ["customresourcedefinitions"]
  verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: traefik-middleware-crd-installer
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: traefik-middleware-crd-installer
subjects:
- kind: ServiceAccount
  name: traefik-middleware-crd-installer
  namespace: traefik
